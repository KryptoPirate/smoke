---
# Descent 2 role tasks
# This collection of tasks will install and configure Descent 2
# to run with the open-source engine d2x-rebirth.
#
# Known bug:
# Certain Descent movies are not playing. This is related to a problem
# introduced with PhysFS 3 - details are listed in the link below.
# https://github.com/dxx-rebirth/dxx-rebirth/issues/379
#
# Note: debian bullseye install PhysFS 3.0.2-5
# https://packages.debian.org/bullseye/libphysfs
#
# debian bullseye installs d2x-rebirth 0.58.1-1.3
# https://packages.debian.org/bullseye/d2x-rebirth1


- name: Initial system checks before installation
  block:

      - name: Collect screen resolution to use in config file
        ansible.builtin.include_tasks: common/tasks/collect_system_info.yml

      - name: Add non-free repository
        ansible.builtin.include_tasks: common/tasks/add_repo.yml

      - name: Pre-install check list
        ansible.builtin.include_tasks: common/tasks/pre_install.yml

      - name: Skip extracting installer if game file found on system
        ansible.builtin.stat:
            path: "{{ base_dir }}/descent2.hog"
        register: is_game_installed


- name: Extract and configure game files from the installer
  block:

      - name: Create temporary working directory for installation files
        ansible.builtin.tempfile:
          state: directory
        register: tmp_dir

      - name: Use innoextract to extract game files
        ansible.builtin.include_tasks: common/tasks/extract_inno.yml

      - name: Copy game files from the temporary directory
        ansible.builtin.include_tasks: common/tasks/copy_files.yml
        loop: "{{ game_files }}"
        loop_control:
            label: "{{ item.dest }}"

      - name: Extract music tracks from the cd image files
        ansible.builtin.include_tasks: common/tasks/extract_cd_tracks.yml
        loop: "{{ cd_images }}"
        loop_control:
            label: "{{ item.dest }}"

  when: not is_game_installed.stat.exists
  always:
      
      - name: Delete the temporary working directory
        ansible.builtin.file:
            path: "{{ tmp_dir.path }}"
            state: absent
        when: tmp_dir.path is defined


- name: Create descent.cfg file
  ansible.builtin.template:
      src: descent.cfg.j2
      dest: "{{ base_dir }}/descent.cfg"
