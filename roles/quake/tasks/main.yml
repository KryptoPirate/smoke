---
# Quake role task
# This collection of tasks will install and configure Quake: The Offering
# and the expansion packs, Scourge of Armagon and Dissolution of Eternity,
# to run with the open-source engine Quakespasm-Spiked.


- name: Initial system checks before installation
  block:

    - name: Collect screen resolution to use in config.cfg
      ansible.builtin.include_tasks: common/tasks/collect_system_info.yml

    - name: Pre-Install check list
      ansible.builtin.include_tasks: common/tasks/pre_install.yml

    - name: Skip extracting installer if game file found on system
      ansible.builtin.stat:
          path: "{{ base_dir }}/id1/pak0.pak"
      register: is_game_installed


- name: Extract and configure game files from the installer
  block:

    - name: Create temporary working directory for installation files
      ansible.builtin.tempfile:
          state: directory
      register: tmp_dir

    - name: Use innoextract to extract game files
      ansible.builtin.include_tasks: common/tasks/extract_inno.yml

    - name: Copy game files from the temporary directory
      ansible.builtin.include_tasks: common/tasks/copy_files.yml
      loop: "{{ game_files }}"
      loop_control:
          label: "{{ item.dest }}"

    - name: Extract music tracks from cd image files
      ansible.builtin.include_tasks: common/tasks/extract_cd_tracks.yml
      loop: "{{ cd_images }}"
      loop_control:
          label: "{{ item.dest }}"

  when: not is_game_installed.stat.exists
  always:

    - name: Delete the temporary working directory
      ansible.builtin.file:
          path: "{{ tmp_dir.path }}"
          state: absent
      when: tmp_dir.path is defined


- name: Download and install Quakespasm-spiked engine
  ansible.builtin.unarchive:
      src: "{{ qss_url }}"
      dest: "{{ qss_dir }}"
      remote_src: yes
      creates: "{{ qss_dir }}/quakespasm-spiked-linux64"


- name: Configure shortcuts to launch game from ChromeOS app menu
  block:

    - name: Download Icon assets from smoke-resources repository
      ansible.builtin.get_url:
          url: "{{ smoke_resources }}/{{ item }}"
          dest: "{{ icon_dir }}/{{ item }}"
          force: no
      loop: "{{ icons }}"

    - name: Create Desktop entries
      ansible.builtin.template:
          src: "{{ item.src }}"
          dest: "{{ item.dest }}"
      loop:
          - { src: quake.desktop.j2, dest: "{{ app_dir }}/quake.desktop" }
          - { src: quake-soa.desktop.j2, dest: "{{ app_dir }}/quake-soa.desktop" }
          - { src: quake-doe.desktop.j2, dest: "{{ app_dir }}/quake-doe.desktop" }
      loop_control:
          label: "{{ item.dest }}"

    - name: Deploy config.cfg files
      ansible.builtin.template:
          src: config.cfg.j2
          dest: "{{ item }}"
      with_items:
          - "{{ base_dir }}/id1/config.cfg"
          - "{{ base_dir }}/hipnotic/config.cfg"
          - "{{ base_dir }}/rogue/config.cfg"
