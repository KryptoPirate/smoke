---
# Quake 2 role task
# This collection of tasks will install and configure Quake 2
# and the expansion packs, The Reckoning, and Ground Zero to 
# run with the open source engine Yamagi.


- name: Initial system checks before installation
  block:

      - name: Collection screen resolution to use in the config for full screen
        ansible.builtin.include_tasks: common/tasks/collect_system_info.yml

      - name: Add contrib repository
        ansible.builtin.include_tasks: common/tasks/add_repo.yml

      - name: Pre-install check list
        ansible.builtin.include_tasks: common/tasks/pre_install.yml

      - name: Skip extracting installer if game file found on system
        ansible.builtin.stat:
            path: "{{ base_dir }}/baseq2/pak0.pak"
        register: is_game_installed


- name: Extract and configure game files from the installer
  block:

      - name: Create temporary working directory for installation files
        ansible.builtin.tempfile:
            state: directory
        register: tmp_dir

      - name: Use innoextract to extract game files
        ansible.builtin.include_tasks: common/tasks/extract_inno.yml

      - name: Copy game files from the temporary directory
        ansible.builtin.include_tasks: common/tasks/copy_files.yml
        loop: "{{ game_files }}"
        loop_control:
            label: "{{ item.dest }}"

  when: not is_game_installed.stat.exists
  always:
    
      - name: Delete the temporary working directory
        ansible.builtin.file:
            path: "{{ tmp_dir.path }}"
            state: absent
        when: tmp_dir.path is defined


- name: Configure shortcuts to launch game from ChromeOS app meny
  block:

      - name: Download Icon assets from smoke-resource repository
        ansible.builtin.get_url:
            url: "{{ smoke_resources }}/{{ item }}"
            dest: "{{ icon_dir }}/{{ item }}"
            force: no
        loop: "{{ icons }}"

      - name: Create Desktop entries
        ansible.builtin.template:
            src: "{{ item.src }}"
            dest: "{{ item.dest }}"
        loop:
            - { src: quake2.desktop.j2, dest: "{{ app_dir }}/quake2.desktop" }
            - { src: quake2-the-reckoning.desktop.j2, dest: "{{ app_dir }}/quake2-the-reckoning.desktop" }
            - { src: quake2-ground-zero.desktop.j2, dest: "{{ app_dir }}/quake2-ground-zero.desktop" }

      - name: Deploy config.cfg files
        ansible.builtin.template:
            src: config.cfg.j2
            dest: "{{ item }}"
        loop:
            - "{{ base_dir }}/baseq2/config.cfg"
            - "{{ base_dir }}/xatrix/config.cfg"
            - "{{ base_dir }}/rogue/config.cfg"
